const S="modulepreload",E=function(p,e){return new URL(p,e).href},_={},f=function(e,t,i){let a=Promise.resolve();if(t&&t.length>0){const r=document.getElementsByTagName("link"),s=document.querySelector("meta[property=csp-nonce]"),o=(s==null?void 0:s.nonce)||(s==null?void 0:s.getAttribute("nonce"));a=Promise.allSettled(t.map(c=>{if(c=E(c,i),c in _)return;_[c]=!0;const l=c.endsWith(".css"),u=l?'[rel="stylesheet"]':"";if(!!i)for(let h=r.length-1;h>=0;h--){const m=r[h];if(m.href===c&&(!l||m.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${c}"]${u}`))return;const d=document.createElement("link");if(d.rel=l?"stylesheet":S,l||(d.as="script"),d.crossOrigin="",d.href=c,o&&d.setAttribute("nonce",o),document.head.appendChild(d),l)return new Promise((h,m)=>{d.addEventListener("load",h),d.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${c}`)))})}))}function n(r){const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=r,window.dispatchEvent(s),!s.defaultPrevented)throw r}return a.then(r=>{for(const s of r||[])s.status==="rejected"&&n(s.reason);return e().catch(n)})};class y{constructor(){this.db=null,this.initialized=!1,this.isOnline=navigator.onLine,this.offlineQueue=[],window.addEventListener("online",()=>{this.isOnline=!0,this.processOfflineQueue()}),window.addEventListener("offline",()=>{this.isOnline=!1})}async initialize(){try{const{initializeApp:e}=await f(async()=>{const{initializeApp:n}=await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js");return{initializeApp:n}},[],import.meta.url),{getFirestore:t}=await f(async()=>{const{getFirestore:n}=await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");return{getFirestore:n}},[],import.meta.url),a=e({apiKey:void 0,authDomain:void 0,projectId:void 0,storageBucket:void 0,messagingSenderId:void 0,appId:void 0});return this.db=t(a),window.location.hostname==="localhost"&&console.log("Development mode: Using production Firestore"),this.initialized=!0,console.log("Firebase initialized successfully"),this.isOnline&&this.processOfflineQueue(),!0}catch(e){return console.error("Firebase initialization failed:",e),this.initialized=!1,!1}}generateShareId(){const e="ABCDEFGHJKMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789";let t="R";for(let i=0;i<7;i++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}async saveQuizResult(e){this.initialized||await this.initialize();const t={timestamp:new Date().toISOString(),type_code:e.typeCode,scores:e.scores,confidence:e.confidence,language:e.language},i=this.generateShareId();if(t.shareId=i,!this.isOnline||!this.initialized)return this.offlineQueue.push({type:"saveResult",data:t}),console.log("Result queued for offline sync"),i;try{const{doc:a,setDoc:n}=await f(async()=>{const{doc:s,setDoc:o}=await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");return{doc:s,setDoc:o}},[],import.meta.url),r=a(this.db,"quiz_results",i);return await n(r,t),console.log("Quiz result saved:",i),await this.updateStatistics(t.type_code,t.language),i}catch(a){return console.error("Error saving quiz result:",a),this.offlineQueue.push({type:"saveResult",data:t}),i}}async getStatistics(e="global"){if(this.initialized||await this.initialize(),!this.isOnline||!this.initialized)return this.getCachedStatistics();try{const{doc:t,getDoc:i}=await f(async()=>{const{doc:r,getDoc:s}=await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");return{doc:r,getDoc:s}},[],import.meta.url),a=t(this.db,"statistics",e),n=await i(a);if(n.exists()){const r=n.data();return localStorage.setItem("matrixme-stats-cache",JSON.stringify({data:r,timestamp:Date.now()})),r}else return await this.initializeStatistics(e)}catch(t){return console.error("Error fetching statistics:",t),this.getCachedStatistics()}}async getResultByShareId(e){if(this.initialized||await this.initialize(),!this.isOnline||!this.initialized)return console.warn("Offline or not initialized - cannot fetch result"),null;try{const{doc:t,getDoc:i}=await f(async()=>{const{doc:r,getDoc:s}=await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");return{doc:r,getDoc:s}},[],import.meta.url),a=t(this.db,"quiz_results",e),n=await i(a);return n.exists()?(console.log("Result found for share ID:",e),n.data()):(console.log("No result found for share ID:",e),null)}catch(t){return console.error("Error fetching result:",t),null}}async updateStatistics(e,t){try{const{doc:i,runTransaction:a}=await f(async()=>{const{doc:s,runTransaction:o}=await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");return{doc:s,runTransaction:o}},[],import.meta.url),n=i(this.db,"statistics","global"),r=i(this.db,"statistics",t);await a(this.db,async s=>{const o=await s.get(n),c=await s.get(r),l=o.exists()?o.data():this.getDefaultStats(),u=c.exists()?c.data():this.getDefaultStats();l.total_users+=1,l.type_distribution[e]=(l.type_distribution[e]||0)+1,l.last_updated=new Date().toISOString(),u.total_users+=1,u.type_distribution[e]=(u.type_distribution[e]||0)+1,u.last_updated=new Date().toISOString(),s.set(n,l),s.set(r,u)}),console.log("Statistics updated successfully")}catch(i){console.error("Error updating statistics:",i)}}async initializeStatistics(e="global"){const t=this.getDefaultStats();try{const{doc:i,setDoc:a}=await f(async()=>{const{doc:r,setDoc:s}=await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");return{doc:r,setDoc:s}},[],import.meta.url),n=i(this.db,"statistics",e);return await a(n,t),t}catch(i){return console.error("Error initializing statistics:",i),t}}getDefaultStats(){return{total_users:0,type_distribution:{BASE:0,CORE:0,PURE:0,MESH:0,SCAN:0,BETA:0,ECHO:0,SAGE:0,HIDE:0,CTRL:0,PICK:0,VIBE:0,NOVA:0,SYNC:0,HYPE:0,FLOW:0},created_at:new Date().toISOString(),last_updated:new Date().toISOString()}}getCachedStatistics(){try{const e=localStorage.getItem("matrixme-stats-cache");if(e){const{data:t,timestamp:i}=JSON.parse(e);if(Date.now()-i<60*60*1e3)return t}}catch(e){console.error("Error reading cached stats:",e)}return this.getDefaultStats()}async processOfflineQueue(){if(!this.initialized||this.offlineQueue.length===0)return;const e=[...this.offlineQueue];this.offlineQueue=[];for(const t of e)try{if(t.type==="saveResult"){const{doc:i,setDoc:a}=await f(async()=>{const{doc:r,setDoc:s}=await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");return{doc:r,setDoc:s}},[],import.meta.url),n=i(this.db,"quiz_results",Date.now().toString());await a(n,t.data),await this.updateStatistics(t.data.type_code,t.data.language),console.log("Offline result synced:",n.id)}}catch(i){console.error("Error processing offline queue item:",i),this.offlineQueue.push(t)}}calculateRarity(e,t){const i=t.total_users,a=t.type_distribution[e]||0;return i===0?{FLOW:.02,NOVA:.01,HIDE:.03,HYPE:.06,BETA:.05,SAGE:.04,SYNC:.07,VIBE:.08,CTRL:.12,PICK:.15,ECHO:.18,SCAN:.13,PURE:.16,MESH:.22,CORE:.21,BASE:.3}[e]||.1:a/i}calculateConfidence(e,t){if(!t||t.length===0)return Math.floor(Math.random()*8)+90;let i=0;["D","E","T","C"].forEach(r=>{const s=t.filter(o=>o.axis===r);if(s.length>0){const o=s.map(u=>u.value||3),c=o.reduce((u,g)=>u+g,0)/o.length,l=o.reduce((u,g)=>u+Math.pow(g-c,2),0)/o.length;i+=Math.max(0,1-l)}});const n=85+i/4*13;return Math.round(Math.min(98,Math.max(85,n)))}}const w=new y,D=Object.freeze(Object.defineProperty({__proto__:null,firebaseService:w},Symbol.toStringTag,{value:"Module"}));export{f as _,D as f};
